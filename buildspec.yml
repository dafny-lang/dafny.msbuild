version: 0.2
phases:
  install:
    runtime-versions:
      dotnet: 3.0
    commands:
      - cd ..
      # TODO: Temporary - fix the dafny script to not use which instead!
      # See https://github.com/dafny-lang/dafny/issues/449
      - yum install -y which
      - yum install -y nuget
      - pip install --no-cache-dir lit OutputCheck pyyaml
      # Get Boogie
      - git clone https://github.com/boogie-org/boogie.git
      - nuget restore boogie/Source/Boogie.sln
      - msbuild boogie/Source/Boogie.sln
      # Get Dafny
      - git clone https://github.com/microsoft/dafny.git
      - msbuild dafny/Source/Dafny.sln
      - export PATH="$PWD/dafny/Binaries:$PATH"
      # Get Z3
      - wget https://github.com/Z3Prover/z3/releases/download/z3-4.8.4/z3-4.8.4.d6df51951f4c-x64-ubuntu-14.04.zip
      - unzip z3*.zip && rm *.zip
      - cp -r z3* dafny/Binaries/z3
      - cd dafny.msbuild
  build:
    commands:
      - dotnet build Source/dafny.msbuild.sln
      - cd Test
      - dotnet build -t:VerifyDafny
      - dotnet build -t:VerifyDafny -p:VerifyDafnyJobs=1
      - dotnet test
